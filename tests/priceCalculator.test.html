<!doctype html>
<html><head><meta charset="utf-8"><title>priceCalculator tests</title>
<style>body{font-family:system-ui;padding:20px} .pass{color:green} .fail{color:red}</style>
</head><body>
<h1>priceCalculator basic tests</h1>
<script src="../js/priceCalculator.js"></script>
<script src="../js/cpfValidation.js"></script>
<div id="results"></div>
<script>
function assert(name, cond){
  const d = document.createElement('div'); d.textContent = name + ': ' + (cond? 'PASS':'FAIL'); d.className = cond? 'pass':'fail'; document.getElementById('results').appendChild(d);
}

// tests
assert('age calc for 2000-01-01 should be >= 25', window.priceCalculator.calculateAge('2000-01-01') >= 25);
assert('applyAgeRules returns base when no rules', window.priceCalculator.applyAgeRules(100,30,[]) === 100);
assert('calculateAccommodation basic', window.priceCalculator.calculateAccommodation(100,2,30,[]) === 200);
assert('calculateEventValue with rule', (function(){
  const rules = [{faixa_min_anos:0, faixa_max_anos:12, percentual_valor_adulto:0.5}];
  return window.priceCalculator.calculateEventValue(200,10,rules) === 100;
})());

// calcTotals
(function(){
  // pass base fields for participants (baseHosp/baseEvent/age)
  const parts = [
    {baseHosp:200, baseEvent:100, age:30},
    {baseHosp:0, baseEvent:50, age:8}
  ];
  const forma = {taxa_gateway_percentual:0.1};
  const totals = window.priceCalculator.calcTotals(parts, forma, null, {hospedagem:[], evento:[]});
  assert('calcTotals subtotalHospedagem', totals.subtotalHospedagem === 200);
  assert('calcTotals subtotalEvento', totals.subtotalEvento === 150);
  assert('calcTotals total with tax', totals.total === +( (200+150)*(1+0.1) ).toFixed(2) );
})();

// CPF validation tests
assert('valid CPF 11144477735', window.cpfValidation.validateCPF('111.444.777-35') === true);
assert('invalid CPF 00000000000', window.cpfValidation.validateCPF('000.000.000-00') === false);

// simple integration: priceCalculator with age rules
assert('integration calc with age rules', (function(){
  const rules = { hospedagem:[{faixa_min_anos:0, faixa_max_anos:12, percentual_valor_adulto:0.5}], evento:[] };
  const p = [{baseHosp: 100, baseEvent: 200, age:10}];
  const totals = window.priceCalculator.calcTotals(p, {taxa_gateway_percentual:0}, null, rules);
  return totals.subtotalEvento === 100 && totals.subtotalHospedagem === 50;
})());

// test reservation-level limite_gratuidade_por_reserva and regra_excedente_gratuito
assert('limite_gratuidade_por_reserva assigns one free and extra charged by regra_excedente_gratuito', (function(){
  // rule: 0-4 anos => 1 free per reservation, excedente charged at 50% of adult; hospedagem base adult = 200
  const regras = { hospedagem: [ {faixa_min_anos:0, faixa_max_anos:4, percentual_valor_adulto:0.0, limite_gratuidade_por_reserva:1, regra_excedente_gratuito: {percentual_valor_adulto:0.5} } ], evento: [] };
  const parts = [ {baseHosp:200, baseEvent:0, age:3}, {baseHosp:200, baseEvent:0, age:4} ];
  const totals = window.priceCalculator.calcTotals(parts, {taxa_gateway_percentual:0}, null, regras);
  // one free (0), one charged 50% = 100 -> subtotalHosp 100
  return totals.subtotalHospedagem === 100 && totals.participants[0].valorHospedagem === 0 && totals.participants[1].valorHospedagem === 100;
})());

// coupon aplicacao tests
(function(){
  // participants: hospedagem 200, evento 100
  const parts = [{valorHospedagem:200, valorEvento:100}];
  const forma = {taxa_gateway_percentual:0};
  // percentual coupon applied to hospedagem (10%) -> desconto = 20
  const cupHosp = {tipo_desconto:'percentual', valor_desconto:0.10, aplicacao:'hospedagem'};
  const t1 = window.priceCalculator.calcTotals(parts, forma, cupHosp);
  assert('coupon percentual aplicacao=hospedagem desconta 20', t1.desconto === 20 && t1.total === 280);
  // percentual coupon applied to evento (50%) -> desconto = 50
  const cupEvent = {tipo_desconto:'percentual', valor_desconto:0.50, aplicacao:'evento'};
  const t2 = window.priceCalculator.calcTotals(parts, forma, cupEvent);
  assert('coupon percentual aplicacao=evento desconta 50', t2.desconto === 50 && t2.total === 250);
  // fixed coupon applied to hospedagem (fixed 150) -> desconto limited to hospedagem (200) => 150
  const cupFixedHosp = {tipo_desconto:'fixo', valor_desconto:150, aplicacao:'hospedagem'};
  const t3 = window.priceCalculator.calcTotals(parts, forma, cupFixedHosp);
  assert('coupon fixo aplicacao=hospedagem desconta max hospedagem', t3.desconto === 150 && t3.total === 150);
  // fixed coupon applied to total (fixed 50) -> desconto 50
  const cupFixedTotal = {tipo_desconto:'fixo', valor_desconto:50, aplicacao:'total'};
  const t4 = window.priceCalculator.calcTotals(parts, forma, cupFixedTotal);
  assert('coupon fixo aplicacao=total desconta 50', t4.desconto === 50 && t4.total === 250);
})();
</script>
</body></html>
